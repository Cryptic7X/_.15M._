name: Market Data Refresh

on:
  schedule:
    # Run twice daily at 5:30 AM and 5:30 PM IST
    # IST 05:30 = UTC 00:00, IST 17:30 = UTC 12:00
    - cron: '0 0,12 * * *'  # Every 12 hours at midnight and noon UTC
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force complete market data refresh'
        required: false
        default: 'false'

jobs:
  market_data_refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Check Current Time
        run: |
          echo "🌍 Current UTC time: $(date -u)"
          echo "🇮🇳 Current IST time: $(TZ='Asia/Kolkata' date)"
          echo "📊 Starting market data refresh..."
      
      - name: Run Market Data Refresh
        env:
          COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
        run: |
          echo "🔄 Fetching high-risk market data..."
          python src/data_fetcher.py --daily-scan
      
      - name: Validate Market Data
        run: |
          if [ -f cache/high_risk_market_data.json ]; then
            COIN_COUNT=$(python -c "
import json
with open('cache/high_risk_market_data.json') as f:
    data = json.load(f)
    print(len(data.get('coins', [])))
")
            echo "✅ Market data contains $COIN_COUNT coins"
            
            if [ "$COIN_COUNT" -lt 50 ]; then
              echo "⚠️ Warning: Only $COIN_COUNT coins found (expected 100+)"
            fi
          else
            echo "❌ Market data file not found!"
            exit 1
          fi
      
      - name: Commit Market Data Updates
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f cache/high_risk_market_data.json ]; then
            git add cache/high_risk_market_data.json
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              TIMESTAMP=$(TZ='Asia/Kolkata' date '+%Y-%m-%d %H:%M IST')
              git commit -m "📊 Market data refresh - $TIMESTAMP [skip ci]"
              git push
              echo "✅ Market data updated successfully"
            fi
          fi
      
      - name: Market Data Summary
        if: always()
        run: |
          echo "📊 Market Data Refresh Complete"
          echo "⏰ Completed at: $(date -u) UTC"
          echo "🕐 IST Time: $(TZ='Asia/Kolkata' date)"
          echo "🔄 Next refresh in 12 hours"
